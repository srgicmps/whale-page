<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Change Password</title>
		<link rel="stylesheet" href="../css/header.css" />
		<link rel="stylesheet" href="../css/login.css" />
		<link rel="stylesheet" href="../css/footer.css" />
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
		<script src="./js/userCheck.js"></script>
		<style>
			.password-requirements {
				margin: 0.5rem 0;
				padding: 0.5rem 1rem;
				background-color: #f8f9fa;
				border-radius: 4px;
				font-size: 0.85rem;
				color: #666;
			}

			.password-requirements p {
				margin: 0 0 0.3rem 0;
				font-size: 0.9rem;
				color: #444;
			}

			.password-requirements ul {
				margin: 0;
				padding-left: 1.2rem;
				list-style-type: none;
			}

			.password-requirements li {
				margin: 0.2rem 0;
				position: relative;
			}

			.password-requirements li:before {
				content: "•";
				position: absolute;
				left: -1rem;
				color: #007bff;
			}

			#changePasswordForm button[type="submit"] {
				width: 100%;
				padding: 1rem;
				background-color: #007bff;
				border: none;
				border-radius: 0.3rem;
				color: #fff;
				font-size: large;
				cursor: pointer;
				margin: 1rem 0rem;
				transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
			}

			#changePasswordForm button[type="submit"]:hover {
				background-color: #0056b3;
				transform: translateY(-2px);
			}

			#change-password-title {
				font-size: 2rem;
				font-weight: 500;
				letter-spacing: -0.5px;
				margin: 0rem 0rem 0rem 0rem;
				color: black;
			}
		</style>
	</head>
	<body>
		<header>
			<nav class="navbar">
				<a id="hamburger-btn">
					<img src="../assets/icons/bars-solid-dark.svg" class="hamburger-btn__darkicon" alt="" />
				</a>
				<a class="logo-container" href="../index.html">
					<img src="../img/logo.png" id="logo" />
				</a>
				<ul id="nav-links" class="navigation-links hidden">
					<li><a href="#">Historia</a></li>
					<li><a href="../src/muntatge.html">Muntatge</a></li>
					<li><a href="../src/news.html">Noticies</a></li>
					<li><a href="../src/alvoltantdelabalena.html">Al voltant de la balena</a></li>
					<li class="admin-link hidden"><a href="./editUsers.html">Edit Users</a></li>
				</ul>
				<a id="login-btn" href="login.html">Log in</a>
				<div id="user-menu" style="display: none">
					<button id="logout-btn">Logout</button>
				</div>
			</nav>
		</header>

		<div class="login-container">
			<form id="changePasswordForm">
				<h3 id="change-password-title">Change Password</h3>
				<div class="password-requirements">
					<p>Password must contain:</p>
					<ul>
						<li>Minimum 12 characters</li>
						<li>Uppercase letters</li>
						<li>Lowercase letters</li>
						<li>Numbers</li>
						<li>Special characters</li>
					</ul>
				</div>
				<div id="input-container">
					<input type="password" id="newPassword" required placeholder="New Password" />
					<input type="password" id="confirmPassword" required placeholder="Confirm Password" />
				</div>
				<div id="change-password-message" class="login-message hidden"></div>
				<button type="submit">Change Password</button>
			</form>
		</div>

		<footer>
			<div class="footer-container">
				<div class="footer-content">
					<div class="footer-info">
						<p>© 2025 Whale Project</p>
						<p>info@whaleproject.org</p>
					</div>
					<div class="footer-social">
						<a href="#"><img src="/assets/icons/facebook.svg" alt="Facebook" /></a>
						<a href="#"><img src="/assets/icons/x.svg" alt="X" /></a>
						<a href="#"><img src="/assets/icons/instagram.svg" alt="Instagram" /></a>
					</div>
				</div>
			</div>
		</footer>

		<script src="/src/js/mobileNav.js"></script>
		<script>
			$(document).ready(function () {
				const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
				const messageContainer = $("#change-password-message");

				if (!loggedInUser || !loggedInUser.is_first_login) {
					window.location.href = "../index.html";
					return;
				}

				function showMessage(message, type) {
					messageContainer.removeClass("hidden error success").addClass(type).text(message).fadeIn();
				}

				$("#changePasswordForm").submit(function (e) {
					e.preventDefault();

					const newPassword = $("#newPassword").val();
					const confirmPassword = $("#confirmPassword").val();

					// Password validation according to requirements
					if (newPassword.length < 12) {
						showMessage("Password must be at least 12 characters long", "error");
						return;
					}
					if (!/[A-Z]/.test(newPassword)) {
						showMessage("Password must contain uppercase letters", "error");
						return;
					}
					if (!/[a-z]/.test(newPassword)) {
						showMessage("Password must contain lowercase letters", "error");
						return;
					}
					if (!/[0-9]/.test(newPassword)) {
						showMessage("Password must contain numbers", "error");
						return;
					}
					if (!/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
						showMessage("Password must contain special characters", "error");
						return;
					}

					if (newPassword !== confirmPassword) {
						showMessage("Passwords don't match!", "error");
						return;
					}

					const users = JSON.parse(localStorage.getItem("user"));
					const userIndex = users.findIndex((u) => u.email === loggedInUser.email);

					if (userIndex !== -1) {
						const salt = CryptoJS.lib.WordArray.random(128 / 8).toString();
						const saltedPassword = newPassword + salt;
						const passwordHash = CryptoJS.SHA256(saltedPassword).toString();

						users[userIndex].password_hash = passwordHash;
						users[userIndex].salt_hash = salt;
						users[userIndex].is_first_login = false;

						localStorage.setItem("user", JSON.stringify(users));
						loggedInUser.is_first_login = false;
						localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

						showMessage("Password changed successfully! Redirecting...", "success");
						setTimeout(() => {
							window.location.href = "../index.html";
						}, 1500);
					}
				});
			});
		</script>
	</body>
</html>
